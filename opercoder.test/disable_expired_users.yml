- name: Create script for user expiration
  copy:
    content: |
      #!/bin/bash
      current_date=$(date +%Y-%m-%d)
      while read -r user expire_date; do
        if [[ "$expire_date" < "$current_date" ]]; then # If the date has passed
          usermod -L "$user" || exit 1
        fi
      done < /etc/users_expiration_dates
    dest: /usr/local/sbin/check_user_expiration.sh
    mode: '0755'
  tags:
    - expiration

- name: Add cron job for user expiration
  cron:
    name: "Check user expiration"
    job: "/usr/local/sbin/check_user_expiration.sh"
    minute: "0"
    hour: "0"
    state: present
  tags:
    - expiration
